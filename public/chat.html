<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fromto Chat</title>
    <link rel="stylesheet" href="https://kartikbansode.github.io/Fromto/public/css/common.css">
    <link rel="stylesheet" href="https://kartikbansode.github.io/Fromto/public/css/chat.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        /* Ensure the full chat container is visible including bottom border radius */
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .chat-page {
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding-bottom: 10px;
            /* Add padding to see bottom border radius */
        }

        .chat-header {
            flex-shrink: 0;
            height: 60px;
        }

        .chat-container {
            flex: 1;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 15px;
            padding: 15px;
            overflow: hidden;
            /* Reduce height to ensure bottom is visible */
            height: calc(100vh - 70px);
            /* 60px header + 10px bottom padding */
            max-height: calc(100vh - 70px);
        }

        .chat-main {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .chat-window {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-radius: 12px;
            /* Ensure shadow is visible */
            margin-bottom: 5px;
        }

        .connection-banner {
            flex-shrink: 0;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
        }

        .message-input-area {
            flex-shrink: 0;
            padding: 10px;
            border-top: 1px solid #e2e8f0;
        }

        /* Fix for mobile devices */
        @media (max-height: 600px) {
            .chat-page {
                padding-bottom: 5px;
            }

            .chat-container {
                height: calc(100vh - 55px);
                /* 50px header + 5px bottom padding */
                max-height: calc(100vh - 55px);
                padding: 10px;
            }

            .connection-banner {
                height: 30px;
                min-height: 30px;
                padding: 0 1rem;
            }

            .message-input-area {
                padding: 5px;
            }
        }

        /* Center the security note */
        .security-note {
            text-align: center;
            width: 100%;
            margin: 2px 0 0 0;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(2px);
        }

        .confirmation-modal {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-overlay.active {
            display: flex;
        }

        .confirmation-modal.active {
            transform: scale(1);
            opacity: 1;
        }

        /* Professional Modal Styling */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(2px);
        }

        .confirmation-modal {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 480px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* Modal Header */
        .modal-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            gap: 1rem;
        }

        .modal-icon-wrapper {
            background: #EBF5FF;
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-icon {
            font-size: 1.5rem;
            color: #4a6bdf;
        }

        .modal-title-section {
            flex: 1;
        }

        .modal-title {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1F2937;
            line-height: 1.4;
        }

        .modal-subtitle {
            margin: 0.25rem 0 0 0;
            color: #6B7280;
            font-size: 0.875rem;
        }

        /* Connection Details Section */
        .connection-details {
            background: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            padding: 1.25rem;
            margin: 1.5rem 0;
        }

        .connection-info-row {
            display: flex;
            align-items: center;
            padding: 0.75rem 0;
        }

        .connection-info-row:not(:last-child) {
            border-bottom: 1px solid #E5E7EB;
        }

        .info-label {
            width: 120px;
            color: #6B7280;
            font-size: 0.875rem;
            margin-left: 0.5rem;
            margin-right: 2rem;
        }

        .info-value {
            flex: 1;
            color: #1F2937;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .info-value i {
            color: #4a6bdf;
            font-size: 0.875rem;
        }

        .fromto-logo {
            width: 180px;
            height: 180px;
            object-fit: contain;
        }

        /* Security Notice */
        .security-notice {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: #FEF3C7;
            border: 1px solid #FCD34D;
            border-radius: 6px;
            margin: 1.5rem 0;
        }

        .security-notice i {
            color: #D97706;
        }

        .security-notice p {
            margin: 0;
            font-size: 0.875rem;
            color: #92400E;
        }

        /* Modal Actions */
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn-secondary {
            padding: 0.75rem 1.5rem;
            border: 1px solid #E5E7EB;
            background: white;
            color: #374151;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: #F9FAFB;
            border-color: #D1D5DB;
        }

        .btn-primary {
            padding: 0.75rem 1.5rem;
            background: #4a6bdf;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: #4a6bdf;
        }

        /* Responsive Design */
        @media (max-width: 640px) {
            .confirmation-modal {
                padding: 1.5rem;
                margin: 1rem;
            }

            .modal-actions {
                flex-direction: column-reverse;
                gap: 0.75rem;
            }

            .btn-secondary,
            .btn-primary {
                width: 100%;
            }

            .info-label {
                width: 100px;
            }
        }


        .connection-details {
            background: #f8fafc;
            border-radius: 8px;
            padding: 0.8rem;
            margin: 0.5rem 0 1rem 0;
            border: 1px solid #e2e8f0;
        }

        .user-email-display {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #4a5568;
        }

        .user-email-display i {
            color: #4a6bdf;
        }

        .modal-content p {
            margin-top: 0.5rem;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(2px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .confirmation-modal {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 480px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.2s ease-out;
        }

        .modal-overlay.active .confirmation-modal {
            transform: scale(1);
            opacity: 1;
        }

        /* Modal Header */
        .modal-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            gap: 1rem;
        }

        .modal-icon-wrapper {
            background: #506eda;
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-icon {
            font-size: 1.5rem;
            color: #fafafa;
        }

        .modal-title-section {
            flex: 1;
        }

        .modal-title {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1F2937;
            line-height: 1.4;
        }

        .modal-subtitle {
            margin: 0.25rem 0 0 0;
            color: #6B7280;
            font-size: 0.875rem;
        }

        /* Modal Actions */
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn-secondary {
            padding: 0.75rem 1.5rem;
            border: 1px solid #E5E7EB;
            background: white;
            color: #374151;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: #F9FAFB;
            border-color: #D1D5DB;
        }

        .btn-danger {
            padding: 0.75rem 1.5rem;
            background: #DC2626;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .btn-danger:hover {
            background: #B91C1C;
        }

        /* Security Notice in Modal */
        .security-notice {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: #FEF3C7;
            border: 1px solid #FCD34D;
            border-radius: 6px;
            margin: 1.5rem 0;
        }

        .security-notice i {
            color: #D97706;
        }

        .security-notice p {
            margin: 0;
            font-size: 0.875rem;
            color: #92400E;
        }

        /* Responsive Design */
        @media (max-width: 640px) {
            .confirmation-modal {
                padding: 1.5rem;
                margin: 1rem;
            }

            .modal-actions {
                flex-direction: column-reverse;
                gap: 0.75rem;
            }

            .btn-secondary,
            .btn-danger {
                width: 100%;
            }
        }



        /* Disconnect card container */
        .disconnect-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* Separator line */
        .card-separator {
            height: 1px;
            background: #e2e8f0;
            margin: 1rem 0;
        }

        .mobile-warning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            color: black;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }
        .mobile-warning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f8fafc;
            color: #2d3748;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        .mobile-warning .content {
            max-width: 500px;
        }
        .mobile-warning .icon {
            font-size: 50px;
            color: #4a6bdf;
            margin-bottom: 20px;
        }
        .mobile-warning h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        .mobile-warning p {
            font-size: 16px;
            line-height: 1.5;
        }
        .mobile-warning .logo {
            width: 100px;
            margin-bottom: 20px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            function checkScreenSize() {
                if (window.innerWidth < 1024) {
                    document.body.innerHTML = `
                        <div class="mobile-warning">
                            <div class="content">

                                <div class="icon"><i class="fa-solid fa-desktop fa-beat"></i></div>
                                <h1>Desktop Only</h1>
                                <p>We're sorry, but this website is only accessible on desktop screens. Please visit us on a desktop device for the best experience.</p>
                            </div>
                        </div>
                    `;
                }
            }
            checkScreenSize();
            window.addEventListener('resize', checkScreenSize);
        });
    </script>
</head>

<body class="chat-page">
    <header class="chat-header">
        <div class="chat-brand">
            <button id="mobileMenuToggle" class="mobile-menu-toggle">
                <i class="fas fa-bars"></i>
            </button>
            <img src="https://kartikbansode.github.io/Fromto/assets/logo-white-full.png" alt="" srcset="">
        </div>
        <div class="chat-actions">
            <div class="connection-status online" id="connectionStatus" title="Online"></div>
            <div class="user-info-header">
                <span id="userEmail">Loading..</span>
                <button id="logoutBtn" class="btn-icon danger" title="Logout">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </header>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="chat-container">
        <aside class="sidebar" id="sidebar">

            <div class="card connection-card">
                <h3><i class="fas fa-user-friends"></i> Your Connection
                    Code</h3>
                <div class="code-section">
                    <div id="userCode" class="code-display">••••••</div>
                    <button id="copyBtn" class="copy-button" title="Copy code">
                        <i class="fas fa-copy"></i>
                        <span class="copy-tooltip">Copied!</span>
                    </button>
                </div>
                <p class="help-text">Share this code to connect with a
                    User</p>
            </div>

            <div class="card connection-form">
                <h3><i class="fas fa-link"></i> Connect to a User</h3>
                <div class="input-group">
                    <input type="text" id="friendCode" placeholder="Enter connection code">
                    <button id="connectBtn" class="btn-primary">
                        <i class="fas fa-plug"></i> Connect
                    </button>
                </div>
                <div id="connectionStatusMessage" class="status-message"></div>
            </div>

            <!-- Update the disconnect card HTML -->
            <div class="card disconnect-card" style="display: none;">
                <!-- Add the new options button section -->
                <!-- Add a separator -->
                <!--<div class="card-separator"></div> -->
                <!-- Existing disconnect button -->
                <h3><i class="fas fa-unlink"></i> Active Connection</h3>
                <button id="disconnectBtn" class="btn-danger" style="width: 100%;">
                    <i class="fas fa-power-off"></i> Disconnect
                </button>
            </div>

        </aside>

        <main class="chat-main">
            <div class="chat-window">
                <div class="connection-banner" id="connectionBanner">
                    <i class="fas fa-check-circle" id="connectionIcon"></i>
                    <span id="connectionText">Disconnected</span>
                    <span id="connectedUserName"></span>
                </div>

                <div class="messages" id="messages">
                    <div class="welcome-message">
                        <div class="welcome-icon">
                            <img src="https://kartikbansode.github.io/Fromto/assets/logo-white-single.png" alt="Fromto Logo" class="fromto-logo">
                        </div>
                        <h3>Welcome to Fromto Chat</h3>
                        <p>Connect with a user using their code to
                            start chatting securely.</p>
                    </div>
                </div>

                <div class="message-input-area" id="chatArea" style="display: none;">
                    <div class="typing-indicator" id="typingIndicator"></div>
                    <div class="input-group">
                        <input type="text" id="messageInput" placeholder="Type a secure message...">
                        <button id="sendBtn" class="btn-primary">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <p class="security-note">
                        <i class="fas fa-lock"></i> Messages are encrypted in transit
                    </p>
                </div>
            </div>
        </main>
    </div>

    <div id="confirmationModal" class="modal-overlay">
        <div class="confirmation-modal">
            <!-- Modal Header -->
            <div class="modal-header">
                <div class="modal-icon-wrapper">
                    <i class="fas fa-plug modal-icon"></i>
                </div>
                <div class="modal-title-section">
                    <h3 class="modal-title">Confirm Connection</h3>
                    <p class="modal-subtitle">Please verify the connection details below</p>
                </div>
            </div>

            <!-- Connection Details -->
            <div class="connection-details">
                <div class="connection-info-row">
                    <div class="info-label">Email</div>
                    <div class="info-value">
                        <i class="fas fa-user"></i>
                        <span id="connectUserEmail"></span>
                    </div>
                </div>
                <div class="connection-info-row">
                    <div class="info-label">Connection Code</div>
                    <div class="info-value">
                        <i class="fas fa-key"></i>
                        <span id="connectCode"></span>
                    </div>
                </div>
            </div>

            <!-- Security Notice -->
            <div class="security-notice">
                <i class="fas fa-shield-alt"></i>
                <p>Please verify the connection details to ensure secure communication.</p>
            </div>


            <!-- Modal Actions -->
            <div class="modal-actions">
                <button id="modalCancel" class="btn-secondary">Cancel</button>
                <button id="modalConfirm" class="btn-primary">
                    <i class="fas fa-plug"></i>
                    Connect
                </button>
            </div>

        </div>
    </div>
    <div id="disconnectConfirmationModal" class="modal-overlay">
        <div class="confirmation-modal">
            <!-- Modal Header -->
            <div class="modal-header">
                <div class="modal-icon-wrapper" style="background: #FEE2E2;">
                    <i class="fas fa-unlink modal-icon" style="color: #DC2626;"></i>
                </div>
                <div class="modal-title-section">
                    <h3 class="modal-title">Confirm Disconnect</h3>
                    <p class="modal-subtitle">Are you sure you want to end this chat?</p>
                </div>
            </div>

            <!-- Warning Notice -->
            <div class="security-notice" style="background: #FEF3C7; border-color: #FCD34D;">
                <i class="fas fa-exclamation-triangle" style="color: #D97706;"></i>
                <p style="color: #92400E;">This will end your current chat session.</p>
            </div>

            <!-- Modal Actions -->
            <div class="modal-actions">
                <button id="cancelDisconnect" class="btn-secondary">Cancel</button>
                <button id="confirmDisconnect" class="btn-danger">
                    <i class="fas fa-unlink"></i>
                    Disconnect
                </button>
            </div>
        </div>
    </div>




    <script src="https://kartikbansode.github.io/Fromto/public/js/firebase-config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Your existing code...

            // Set initial disconnected state
            updateUIToDisconnected();

            // Rest of your existing code...
        });

        let currentUser = null;
        let currentChat = null;
        let lastScrollPosition = 0;
        let isTyping = false;
        let typingTimeout = null;
        let messageListeners = {}; // Track active listeners
        let modalResolver;
        const modal = {
            overlay: document.getElementById('confirmationModal'),
            modal: document.querySelector('.confirmation-modal'),
            message: document.getElementById('modalMessage'),
            confirmBtn: document.getElementById('modalConfirm'),
            cancelBtn: document.getElementById('modalCancel'),
            title: document.querySelector('.modal-title'),
            icon: document.querySelector('.modal-icon')
        };


        // Authentication check
        firebase.auth().onAuthStateChanged((user) => {
            if (!user) window.location.href = 'https://kartikbansode.github.io/Fromto/public/login.html';
            currentUser = user;
            document.getElementById('userEmail').textContent = user.email;
            setupUserCode();
            initPresence();
        });

        // User code setup
        // User code setup
        function setupUserCode() {
            const userRef = firebase.database().ref('users/' + currentUser.uid);
            userRef.once('value').then((snapshot) => {
                const userData = snapshot.val();
                if (!userData?.code) {
                    // Generate new code for user
                    const newCode = Math.random().toString(36).substr(2, 6).toUpperCase();
                    userRef.set({
                        email: currentUser.email,
                        code: newCode,
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    }).then(() => {
                        document.getElementById('userCode').textContent = newCode;
                    }).catch(error => {
                        console.error("Error saving user code:", error);
                        document.getElementById('userCode').textContent = 'Error';
                    });
                } else {
                    document.getElementById('userCode').textContent = userData.code;
                }
            }).catch(error => {
                console.error("Error fetching user code:", error);
                document.getElementById('userCode').textContent = 'Error';
            });
        }

        function updateUIToDisconnected() {
    // Update connection icon and text
    document.getElementById('connectionIcon').className = 'fas fa-times-circle';
    document.getElementById('connectionIcon').style.color = '#e53e3e';
    document.getElementById('connectionText').textContent = 'Disconnected';
    document.getElementById('connectedUserName').textContent = '';

    // Hide chat area
    document.getElementById('chatArea').style.display = 'none';

    // Show welcome message
    document.getElementById('messages').innerHTML = `
        <div class="welcome-message">
            <div class="welcome-icon">
                <img src="https://kartikbansode.github.io/Fromto/assets/logo-white-single.png" alt="Fromto Logo" class="fromto-logo">
            </div>
            <h3>Welcome to Fromto Chat</h3>
            <p>Connect with a user using their code to start chatting securely.</p>
        </div>
    `;

    // Hide disconnect card and show connection form
    const disconnectCard = document.querySelector('.disconnect-card');
    const connectionForm = document.querySelector('.connection-form');

    if (disconnectCard) {
        disconnectCard.style.display = 'none';
    }

    if (connectionForm) {
        connectionForm.style.display = 'block';
    }

    // Reset and enable the input field
    const friendCodeInput = document.getElementById('friendCode');
    if (friendCodeInput) {
        friendCodeInput.value = '';
        friendCodeInput.disabled = false;
        friendCodeInput.readOnly = false;
    }

    // Reset current chat
    currentChat = null;
}




        // Fix for multiple message submissions
        let isConnecting = false;
        let isSending = false;

        // Connect to friend with debounce
        document.getElementById('connectBtn').addEventListener('click', function () {
            if (isConnecting) return; // Prevent multiple clicks

            isConnecting = true;
            this.disabled = true;

            connectToFriend()
                .then(() => {
                    setTimeout(() => {
                        isConnecting = false;
                        this.disabled = false;
                    }, 1000);
                })
                .catch((error) => {
                    console.error("Connection error:", error);
                    isConnecting = false;
                    this.disabled = false;
                    showStatusMessage(error.message || 'Connection failed', 'error');
                });
        });

        // Send message with debounce
        document.getElementById('sendBtn').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        function sendMessage() {
            if (isSending) return;

            const input = document.getElementById('messageInput');
            const text = input.value.trim();

            if (!text || !currentChat) return;

            isSending = true;
            document.getElementById('sendBtn').disabled = true;

            firebase.database().ref('chats/' + currentChat + '/messages').push({
                text: text,
                senderId: currentUser.uid,
                timestamp: Date.now()
            }).then(() => {
                input.value = '';
                scrollToBottom();
                input.focus();
            }).catch(error => {
                console.error("Error sending message:", error);
                showStatusMessage('Failed to send message', 'error');
            }).finally(() => {
                setTimeout(() => {
                    isSending = false;
                    document.getElementById('sendBtn').disabled = false;
                }, 500);
            });
        }
        const displayedMessages = new Set(); // Add this at the top with other variables

        function displayMessage(message) {
            // Check if message was already displayed
            if (displayedMessages.has(message.id)) {
                return;
            }

            const messagesDiv = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.senderId === currentUser.uid ? 'sent' : 'received'}`;

            const formattedTime = new Date(message.timestamp).toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit'
            });

            messageElement.innerHTML = `
        <div class="message-content">${message.text}</div>
        <div class="message-time">${formattedTime}</div>
    `;

            messagesDiv.appendChild(messageElement);
            displayedMessages.add(message.id);

            if (isScrolledToBottom()) {
                scrollToBottom();
            }
        }

        function listenToMessages() {
            // Clear any existing listeners
            if (messageListeners[currentChat]) {
                firebase.database().ref('chats/' + currentChat + '/messages')
                    .off('child_added', messageListeners[currentChat]);
            }

            // Clear displayed messages set
            displayedMessages.clear();

            const messagesRef = firebase.database().ref('chats/' + currentChat + '/messages');

            // Clear messages container
            document.getElementById('messages').innerHTML = '';

            // First, load all existing messages
            messagesRef.once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const messages = [];
                    snapshot.forEach((childSnapshot) => {
                        messages.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });

                    // Sort messages by timestamp
                    messages.sort((a, b) => a.timestamp - b.timestamp);

                    // Display messages
                    messages.forEach(message => {
                        displayMessage(message);
                    });

                    // Scroll to bottom
                    setTimeout(scrollToBottom, 100);
                }

                // Listen for new messages
                const listener = (snapshot) => {
                    const message = {
                        id: snapshot.key,
                        ...snapshot.val()
                    };
                    displayMessage(message);
                };

                // Store and attach the listener
                messageListeners[currentChat] = listener;
                messagesRef.on('child_added', listener);
            });
        }

        // Add these with your other variables at the top
        const disconnectModal = document.getElementById('disconnectConfirmationModal');
        const confirmDisconnectBtn = document.getElementById('confirmDisconnect');
        const cancelDisconnectBtn = document.getElementById('cancelDisconnect');


        function displayMessage(message) {
            // Skip if already displayed
            if (displayedMessages.has(message.id)) {
                return;
            }

            const messagesDiv = document.getElementById('messages');
            const messageElement = document.createElement('div');

            // Add appropriate class based on sender
            messageElement.className = `message ${message.senderId === currentUser.uid ? 'sent' : 'received'}`;

            // Format the timestamp
            const formattedTime = new Date(message.timestamp).toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit'
            });

            // Create message HTML
            messageElement.innerHTML = `
        <div class="message-content">${message.text}</div>
        <div class="message-time">${formattedTime}</div>
    `;

            // Add message to the chat
            messagesDiv.appendChild(messageElement);

            // Track that we've displayed this message
            displayedMessages.add(message.id);

            // Auto-scroll if at bottom
            if (isScrolledToBottom()) {
                scrollToBottom();
            }
        }


        // UI Helpers
        function showStatusMessage(text, type = 'success') {
            const statusDiv = document.getElementById('connectionStatusMessage');
            statusDiv.textContent = text;
            statusDiv.className = `status-message ${type}`;
            statusDiv.style.display = 'block';
            setTimeout(() => {
                statusDiv.style.opacity = '0';
                setTimeout(() => {
                    statusDiv.textContent = '';
                    statusDiv.style.display = 'none';
                    statusDiv.style.opacity = '1';
                }, 300);
            }, 3000);
        }

        function isScrolledToBottom() {
            const messagesDiv = document.getElementById('messages');
            return messagesDiv.scrollHeight - messagesDiv.clientHeight <= messagesDiv.scrollTop + 100;
        }

        function scrollToBottom() {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Copy code functionality with improved mobile support
        document.getElementById('copyBtn').addEventListener('click', () => {
            const codeText = document.getElementById('userCode').textContent;

            // Use a more reliable copy method
            const copyToClipboard = (text) => {
                // Create a temporary element
                const el = document.createElement('textarea');
                el.value = text;
                el.setAttribute('readonly', '');
                el.style.position = 'absolute';
                el.style.left = '-9999px';
                document.body.appendChild(el);

                // Handle iOS devices
                if (navigator.userAgent.match(/ipad|ipod|iphone/i)) {
                    const range = document.createRange();
                    range.selectNodeContents(el);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                    el.setSelectionRange(0, 999999);
                } else {
                    el.select();
                }

                // Execute copy command
                const successful = document.execCommand('copy');
                document.body.removeChild(el);

                return successful;
            };

            // Try modern clipboard API first
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(codeText)
                    .then(() => {
                        document.getElementById('copyBtn').classList.add('copied');
                        setTimeout(() => {
                            document.getElementById('copyBtn').classList.remove('copied');
                        }, 1500);
                    })
                    .catch(() => {
                        // Fallback to execCommand
                        if (copyToClipboard(codeText)) {
                            document.getElementById('copyBtn').classList.add('copied');
                            setTimeout(() => {
                                document.getElementById('copyBtn').classList.remove('copied');
                            }, 1500);
                        } else {
                            showStatusMessage('Failed to copy code', 'error');
                        }
                    });
            } else {
                // Fallback for browsers without clipboard API
                if (copyToClipboard(codeText)) {
                    document.getElementById('copyBtn').classList.add('copied');
                    setTimeout(() => {
                        document.getElementById('copyBtn').classList.remove('copied');
                    }, 1500);
                } else {
                    showStatusMessage('Failed to copy code', 'error');
                }
            }
        });

        // Typing indicator
        document.getElementById('messageInput').addEventListener('input', () => {
            if (!isTyping && currentChat) {
                isTyping = true;
                // You can implement typing indicator logic here
                // For example: firebase.database().ref('chats/' + currentChat + '/typing/' + currentUser.uid).set(true);
            }

            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                isTyping = false;
                // Clear typing indicator
                // For example: firebase.database().ref('chats/' + currentChat + '/typing/' + currentUser.uid).remove();
            }, 1000);
        });

        document.getElementById('messages').addEventListener('scroll', function () {
            lastScrollPosition = this.scrollTop;
        });

        // Presence system
        function initPresence() {
            const presenceRef = firebase.database().ref('users/' + currentUser.uid + '/status');
            firebase.database().ref('.info/connected').on('value', (snapshot) => {
                if (snapshot.val()) {
                    presenceRef.onDisconnect().set('offline');
                    presenceRef.set('online');
                    document.getElementById('connectionStatus').classList.add('online');
                } else {
                    document.getElementById('connectionStatus').classList.remove('online');
                }
            });
        }

        // Logout functionality with cleanup
        function logout() {
            // Clean up all listeners
            Object.keys(messageListeners).forEach(chatId => {
                firebase.database().ref('chats/' + chatId + '/messages').off('child_added', messageListeners[chatId]);
            });

            // Clear user status
            if (currentUser) {
                firebase.database().ref('users/' + currentUser.uid + '/status').set('offline');
            }

            // Clear session storage
            sessionStorage.clear();
            localStorage.removeItem('fromto_user');

            // Sign out and redirect
            firebase.auth().signOut().then(() => window.location.replace('login.html'));
        }

        document.getElementById('logoutBtn').addEventListener('click', logout);

        // Mobile menu functionality
        document.addEventListener('DOMContentLoaded', function () {
            // Fix for mobile menu toggle
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            if (mobileMenuToggle) {
                // Remove any existing event listeners
                mobileMenuToggle.removeEventListener('click', openSidebar);

                // Add new event listener with direct function
                mobileMenuToggle.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    sidebar.classList.add('active');
                    sidebarOverlay.classList.add('active');
                    document.body.classList.add('sidebar-open');
                });
            }

            if (sidebarOverlay) {
                // Remove any existing event listeners
                sidebarOverlay.removeEventListener('click', closeSidebar);

                // Add new event listener with direct function
                sidebarOverlay.addEventListener('click', function (e) {
                    e.preventDefault();
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                    document.body.classList.remove('sidebar-open');
                });
            }
        });

        function openSidebar() {
            document.getElementById('sidebar').classList.add('active');
            document.getElementById('sidebarOverlay').classList.add('active');
            document.body.classList.add('sidebar-open');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('sidebarOverlay').classList.remove('active');
            document.body.classList.remove('sidebar-open');
        }

        // Handle window resize
        window.addEventListener('resize', function () {
            if (window.innerWidth > 768) {
                closeSidebar();
            }

            // Update vh variable for mobile browsers
            updateViewportHeight();
        });

        // Function to update viewport height
        function updateViewportHeight() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }

        // Function to ensure chat fits on one screen
        function ensureChatFitsScreen() {
            // Get viewport dimensions
            const viewportHeight = window.innerHeight;

            // Get element heights
            const headerHeight = document.querySelector('.chat-header').offsetHeight;
            const containerPadding = 30; // 15px top + 15px bottom
            const connectionBannerHeight = document.getElementById('connectionBanner').offsetHeight;
            const messageInputHeight = document.getElementById('chatArea').offsetHeight || 60; // Default if hidden

            // Calculate available height for messages
            const availableHeight = viewportHeight - headerHeight - containerPadding - connectionBannerHeight - messageInputHeight;

            // Set messages container height
            const messagesContainer = document.getElementById('messages');
            messagesContainer.style.height = `${availableHeight}px`;
            messagesContainer.style.maxHeight = `${availableHeight}px`;

            // Ensure the chat container doesn't exceed viewport
            const chatContainer = document.querySelector('.chat-container');
            chatContainer.style.height = `${viewportHeight - headerHeight}px`;
            chatContainer.style.maxHeight = `${viewportHeight - headerHeight}px`;

            // Force scroll to bottom after resize
            scrollToBottom();
        }

        // Call this function on important events
        window.addEventListener('load', ensureChatFitsScreen);
        window.addEventListener('resize', ensureChatFitsScreen);

        // Modify the existing DOMContentLoaded handler
        document.addEventListener('DOMContentLoaded', function () {
            // Set initial vh variable for mobile browsers
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);

            // Set initial disconnected state
            document.getElementById('connectionIcon').className = 'fas fa-times-circle';
            document.getElementById('connectionIcon').style.color = '#e53e3e';
            document.getElementById('connectionText').textContent = 'Disconnected';
            document.getElementById('connectedUserName').textContent = '';

            // Set disconnected banner style
            document.getElementById('connectionBanner').style.backgroundColor = '#ebf4ff';
            document.getElementById('connectionBanner').style.borderBottom = '1px solid #bee3f8';
            document.getElementById('connectionBanner').style.color = '#822727';

            // Ensure chat fits on screen
            ensureChatFitsScreen();

            // Focus on message input when chat area is displayed
            const observer = new MutationObserver(function (mutations) {
                mutations.forEach(function (mutation) {
                    if (mutation.target.style.display !== 'none') {
                        document.getElementById('messageInput').focus();
                    }
                });
            });

            observer.observe(document.getElementById('chatArea'), {
                attributes: true,
                attributeFilter: ['style']
            });

            // Improve touch interactions
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                // Add active state for visual feedback
                button.addEventListener('touchstart', function (e) {
                    this.classList.add('active');
                }, { passive: true });

                button.addEventListener('touchend', function () {
                    this.classList.remove('active');
                }, { passive: true });
            });

            // Fix for iOS double-tap zoom on buttons
            const interactiveElements = document.querySelectorAll('button, a');
            interactiveElements.forEach(el => {
                el.addEventListener('touchend', function (e) {
                    // Prevent default only for buttons and links, not inputs
                    if (this.tagName !== 'INPUT') {
                        e.preventDefault();
                    }
                }, { passive: false });
            });

            // Fix for iOS input zoom
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('focus', function () {
                    // Add a minimum font-size to prevent iOS zoom
                    if (parseInt(window.getComputedStyle(this).fontSize) < 16) {
                        this.style.fontSize = '16px';
                    }
                });
            });
        });

        // Function to adjust chat container height
        function adjustChatContainerHeight() {
            const windowHeight = window.innerHeight;
            const headerHeight = document.querySelector('.chat-header').offsetHeight;
            const chatContainer = document.querySelector('.chat-container');
            const messagesContainer = document.getElementById('messages');
            const messageInputArea = document.getElementById('chatArea');
            const connectionBanner = document.getElementById('connectionBanner');

            // Set chat container height
            chatContainer.style.height = `${windowHeight - headerHeight}px`;
            chatContainer.style.maxHeight = `${windowHeight - headerHeight}px`;

            // Adjust messages container to account for input area and connection banner
            const inputAreaHeight = messageInputArea.offsetHeight || 60; // Default if hidden
            const bannerHeight = connectionBanner.offsetHeight || 40; // Default if hidden

            // Set messages container height
            if (messagesContainer) {
                messagesContainer.style.maxHeight = `calc(100% - ${inputAreaHeight + bannerHeight}px)`;
            }
        }

        // Call this function on window resize as well
        window.addEventListener('resize', adjustChatContainerHeight);

        // Connection handler
        async function connectToFriend() {
            const friendCode = document.getElementById('friendCode').value.trim().toUpperCase();

            // First get the user data
            const snapshot = await firebase.database().ref('users').orderByChild('code').equalTo(friendCode).once('value');
            const data = snapshot.val();

            if (!data) {
                throw new Error('No user found with this code');
            }

            const friendId = Object.keys(data)[0];
            const friendEmail = data[friendId].email;

            if (friendId === currentUser.uid) {
                throw new Error('Cannot connect to yourself');
            }

            // Show confirmation dialog with email
            const confirm = await showConfirmation(
                'Confirm Connection',
                `Connect to user with code: ${friendCode}?`,
                'connect',
                friendEmail
            );

            if (!confirm) {
                showStatusMessage('Connection cancelled', 'info');
                return;
            }

            // Rest of your existing connection code...
            // Remove any existing message listeners
            if (currentChat && messageListeners[currentChat]) {
                firebase.database().ref('chats/' + currentChat + '/messages').off('child_added', messageListeners[currentChat]);
                delete messageListeners[currentChat];
            }

            currentChat = [currentUser.uid, friendId].sort().join('_');
            document.getElementById('chatArea').style.display = 'flex';
            document.getElementById('connectionBanner').style.display = 'flex';

            // Update connection status to connected with green check icon
            document.getElementById('connectionIcon').className = 'fas fa-check-circle';
            document.getElementById('connectionIcon').style.color = '#38a169';
            document.getElementById('connectionText').textContent = 'Connected to -';
            document.getElementById('connectedUserName').textContent = friendEmail;

            // Set connected banner style
            document.getElementById('connectionBanner').style.backgroundColor = '#ebf4ff';
            document.getElementById('connectionBanner').style.borderBottom = '1px solid #bee3f8';
            document.getElementById('connectionBanner').style.color = '#2c5282';

            // Clear messages container first
            document.getElementById('messages').innerHTML = '';

            // Close sidebar on mobile after connecting
            if (window.innerWidth <= 768) {
                closeSidebar();
            }

            // Start listening to messages - this will load all messages and scroll to bottom
            listenToMessages();

            showStatusMessage('Connected successfully!', 'success');

            // After connection is established and UI is updated
            setTimeout(ensureChatFitsScreen, 0);

            // After successful connection
            document.querySelector('.connection-form').style.display = 'none';
            document.querySelector('.disconnect-card').style.display = 'block';

            // Disable connection inputs
            document.getElementById('friendCode').disabled = true;
            document.getElementById('connectBtn').disabled = true;
        }

        // Disconnect button click handler
        document.getElementById('disconnectBtn').addEventListener('click', () => {
            disconnectModal.classList.add('active');
        });

        // Handle cancel disconnect
        cancelDisconnectBtn.addEventListener('click', () => {
            disconnectModal.classList.remove('active');
        });

        // Handle confirm disconnect
        confirmDisconnectBtn.addEventListener('click', async () => {
            try {
                // Remove message listeners for current chat
                if (currentChat && messageListeners[currentChat]) {
                    firebase.database().ref('chats/' + currentChat + '/messages').off('child_added', messageListeners[currentChat]);
                    delete messageListeners[currentChat];
                }

                // Update UI to disconnected state
                updateUIToDisconnected();

                // Show success message
                showStatusMessage('Disconnected successfully', 'success');

            } catch (error) {
                console.error('Error disconnecting:', error);
                showStatusMessage('Failed to disconnect', 'error');
            } finally {
                // Hide the modal
                disconnectModal.classList.remove('active');
            }
        });

        // Close modal when clicking outside
        disconnectModal.addEventListener('click', (e) => {
            if (e.target === disconnectModal) {
                disconnectModal.classList.remove('active');
            }
        });

        // Close modal on escape key press
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && disconnectModal.classList.contains('active')) {
                disconnectModal.classList.remove('active');
            }
        });



        function showConfirmation(title, message, type = 'warning', userEmail = '') {
            return new Promise((resolve) => {
                // Update modal content
                modal.title.textContent = title;

                // Set the email and code in the modal
                if (userEmail) {
                    document.getElementById('connectUserEmail').textContent = userEmail;
                    document.getElementById('connectCode').textContent = message.split(': ')[1].replace('?', '');
                }

                // Show modal with animation
                modal.overlay.classList.add('active');
                modal.modal.classList.add('active');

                // Update button and icon styling based on type
                if (type === 'connect') {
                    modal.icon.className = 'fas fa-plug modal-icon';
                    modal.confirmBtn.className = 'btn-primary';
                    modal.confirmBtn.innerHTML = '<i class="fas fa-plug"></i> Connect';
                } else {
                    modal.icon.className = 'fas fa-unlink modal-icon';
                    modal.confirmBtn.className = 'btn-danger';
                    modal.confirmBtn.innerHTML = '<i class="fas fa-unlink"></i> Disconnect';
                }

                modalResolver = resolve;
            });
        }



        // Handle modal interactions
        modal.confirmBtn.addEventListener('click', () => {
            modal.overlay.classList.remove('active');
            modal.modal.classList.remove('active');
            if (modalResolver) modalResolver(true);
        });

        modal.cancelBtn.addEventListener('click', () => {
            modal.overlay.classList.remove('active');
            modal.modal.classList.remove('active');
            if (modalResolver) modalResolver(false);
        });

        modal.overlay.addEventListener('click', (e) => {
            if (e.target === modal.overlay) {
                modal.overlay.classList.remove('active');
                modal.modal.classList.remove('active');
                if (modalResolver) modalResolver(false);
            }
        });
    </script>
    <script src="https://kartikbansode.github.io/Fromto/public/js/chat.js"></script>
</body>
</html>